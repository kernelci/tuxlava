device_type: "x86_64"

job_name: "tuxlava@nfs-x86_64: boot"
priority: 50
visibility: "public"

context:
    test_character_delay: 10
    extra_kernel_args: rootwait

timeouts:
  job:
    minutes: 20
  connection:
    minutes: 2
  actions:
    power-off:
      seconds: 30
    finalize:
      seconds: 60

actions:
- deploy:
    to: tftp
    timeout:
      minutes: 5
    os: debian
    kernel:
      url: "https://example.com/Image.gz"
      compression: gz
      type: image
    modules:
      url: "https://example.com/modules.tar.xz"
      path: /usr/
      compression: xz
    nfsrootfs:
      url: "https://example.com/rootfs.tar.xz"
      compression: xz
      format: tar
      apply-overlay: true
      overlays:
        overlay-00:
          url: "https://example.com/ltp.tar.xz"
          path: "/"
          format: tar
          compression: xz
- boot:
    method:
      ipxe
    commands: nfs
    parameters:
      shutdown-message: 'reboot: Restarting system'
    timeout:
      minutes: 15
    auto_login:
      login_prompt: 'login:'
      username: root
    prompts:
    - 'root@(.*):[/~]#'

- test:
    timeout:
      minutes: 5
    definitions:
    - from: inline
      repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: prep-tests
          description: "Device preparation"
        run:
          steps:
          - export STORAGE_DEV=$(lava-target-storage SATA || lava-target-storage USB)
          - test -n "${STORAGE_DEV}" || lava-test-raise "STORAGE_DEV not found; job exit"
          - echo "y" | mkfs.ext4 ${STORAGE_DEV} || lava-test-raise "mkfs.ext4 ${STORAGE_DEV} failed; job exit"
          - mkdir -p /scratch
          - mount ${STORAGE_DEV} /scratch && echo "mounted" || lava-test-raise "mount ${STORAGE_DEV} failed; job exit"
          - df -h
          - mount
      name: prep-inline
      path: inline/prep.yaml
