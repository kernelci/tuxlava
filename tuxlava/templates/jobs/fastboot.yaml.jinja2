{% set prefix_len = 'fastboot-'|length %}
device_type: "{{ device.name[prefix_len:] }}"

{% if tests %}
job_name: "tuxlava@{{ device.name }}: {{ tests|map(attribute="name")|join(", ")}}"
{% else %}
job_name: "tuxlava@{{ device.name }}: boot"
{% endif %}
priority: {{ LAVA_JOB_PRIORITY }}
visibility: "{{ visibility }}"

reboot_to_fastboot: {{ reboot_to_fastboot|default("false") }}

{% block tags %}
{% if tags is defined and tags is sequence and tags is not string %}
tags:
{% for tag in tags %}
{% if tag|length %}
  - {{ tag }}
{% endif %}
{% endfor %}
{% endif %}
{% endblock tags %}

context:
    test_character_delay: 10

{%- set deploy_download_timeout = timeouts.deploy|default(25) %}
{%- set deploy_timeout = timeouts.deploy|default(30) %}
{%- set boot_timeout = timeouts.boot|default(25) %}

{% block timeouts %}
timeouts:
  job:
    minutes: {{ deploy_download_timeout + deploy_timeout + boot_timeout + tests_timeout }}
  connection:
    minutes: 2
  actions:
    power-off:
      seconds: 60
    finalize:
      seconds: 120
{% if LAVA_QUEUE_TIMEOUT is defined %}
  queue:
    hours: {{ LAVA_QUEUE_TIMEOUT }}
{% endif %}
{% endblock %}

actions:
- deploy:
    to: downloads
    timeout:
      minutes: {{ deploy_download_timeout }}
    os: {{ deploy_os|default(debian) }}
    images:
{% if bios and device.supports_bios %}
      partition:0:
        url: "{{ bios }}"
{% endif %}
{% if ramdisk and device.supports_ramdisk %}
      ramdisk:
        url: "{{ ramdisk }}"
{% endif %}
      kernel:
        url: "{{ kernel }}"
{% if compression(kernel)[1] is not none %}
        compression: {{ compression(kernel)[1] }}
        type: image
{% endif %}
{% if dtb %}
      dtb:
        url: "{{ dtb }}"
{% endif %}
{% if modules %}
      modules:
        url: "{{ modules[0] }}"
        path: {{ modules[1] }}
{% if compression(modules[0])[1] is not none %}
        compression: {{ compression(modules[0])[1] }}
{% endif %}
{% endif %}
      {{ device.downloads_image_name }}:
        url: "{{ rootfs }}"
{% if compression(rootfs)[1] is not none %}
        compression: {{ compression(rootfs)[1] }}
{% endif %}
{% if compression(rootfs)[0] is not none %}
        format: {{ compression(rootfs)[0] }}
{% endif %}
{% if overlays %}
        overlays:
{% if tests or device.needs_storage_prep %}
          lava: true
{% endif %}
{% for name, overlay, dst in overlays %}
          {{ name }}:
            url: "{{ overlay }}"
            path: "{{ dst }}"
{% if compression(overlay)[0] is not none %}
            format: {{ compression(overlay)[0] }}
{% endif %}
{% if compression(overlay)[1] is not none %}
            compression: {{ compression(overlay)[1] }}
{% endif %}
{% endfor %}
{% elif tests or device.needs_storage_prep %}
        overlays:
          lava: true
{% endif %}
    postprocess:
      docker:
        image: "{{ deploy_docker_image|default('linaro/kir:20250728') }}"
        local: true
        steps:
        - /kir/lava/board_setup.sh {{ device.name[9:] }} rootfs "/usr/"
- deploy:
    to: fastboot
    os: {{ deploy_os|default(debian) }}
    timeout:
      minutes: {{ deploy_timeout }}
    docker:
      image: "{{ deploy_fastboot_docker_image|default('linaro/kir:20250728') }}"
      local: true
    images:
{% if device.needs_partition_flash %}
      partition:0:
        url: downloads://gpt_both0.bin
        reboot: hard-reset
{% endif %}
{% if device.needs_boot_img %}
      boot:
        url: downloads://boot.img
{% if device.needs_boot_img_reboot %}
        reboot: hard-reset
{% endif %}
{% endif %}
{% if device.needs_vendor_boot %}
      vendor_boot:
        url: downloads://vendor_boot.img
{% endif %}
      {{ device.fastboot_image_name }}:
        url: downloads://rootfs.img

{% for cmd in device.pre_boot_commands %}
- command:
    name: {{ cmd }}
{% endfor %}
- boot:
{% if device.boot_method == 'u-boot' %}
    commands:
{% for cmd in device.boot_commands %}
    - {{ cmd }}
{% endfor %}
    method: u-boot
{% else %}
    docker:
      image: "{{ boot_docker_image|default('linaro/kir:20250728') }}"
{% if device.boot_docker_local %}
      local: true
{% endif %}
    method: fastboot
{% endif %}
    timeout:
      minutes: {{ boot_timeout }}
    auto_login:
      login_prompt: 'login:'
      username: root
    prompts:
    - 'root@(.*):[/~]#'
{% for prompt in device.extra_prompts %}
    - '{{ prompt }}'
{% endfor %}
{% for prompt in tux_prompt %}
    - "{{ prompt }}"{% endfor %}
{% if device.erase_commands %}
    commands:
{% for cmd in device.erase_commands %}
      - erase {{ cmd }}
{% endfor %}
{% endif %}
{% for cmd in device.post_boot_commands %}
- command:
    name: {{ cmd }}
{% endfor %}

{% if device.needs_storage_prep %}
- test:
    timeout:
      minutes: 5
    definitions:
    - from: inline
      repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: prep-tmp-disk
          description: "Mount local disk for tmp space"
        run:
          steps:
          - export STORAGE_DEV={{ device.storage_device }}
          - test -n "${STORAGE_DEV}" || lava-test-raise "STORAGE_DEV not found; job exit"
          - echo "y" | mkfs.ext4 ${STORAGE_DEV} || lava-test-raise "mkfs.ext4 ${STORAGE_DEV} failed; job exit"
          - mkdir -p /scratch
          - mount ${STORAGE_DEV} /scratch && echo "mounted" || lava-test-raise "mount ${STORAGE_DEV} failed; job exit"
          - df -h
          - mount
      name: prep-tmp-disk
      path: inline/prep.yaml
{% endif %}
