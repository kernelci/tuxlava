{% set prefix_len = 'nfs-'|length -%}
{%- set rootfs_format = compression(rootfs)[0] -%}
{%- set is_tarball = (rootfs_format == "tar") -%}
{%- set is_cpio = (rootfs_format == "cpio.newc" or "ramdisk" in rootfs|lower) -%}
{%- if is_cpio -%}
{%-   set ramdisk = rootfs -%}
{%- endif -%}
device_type: "{{ device.name[prefix_len:] }}"

{% if tests %}
job_name: "tuxlava@{{ device.name }}: {{ tests|map(attribute="name")|join(", ")}}"
{% else %}
job_name: "tuxlava@{{ device.name }}: boot"
{% endif %}
priority: {{ LAVA_JOB_PRIORITY }}
visibility: "{{ visibility }}"

{# Use device class attributes for kernel args and context #}
{% set extra_kernel_args = device.device_kernel_args %}
context:
{% for key, value in device.context_overrides.items() %}
{% if value is string and (value.startswith(',') or value.startswith("'") or ':' in value) %}
    {{ key }}: '{{ value }}'
{% else %}
    {{ key }}: {{ value }}
{% endif %}
{% endfor %}
{% if extra_kernel_args or tux_boot_args %}
    extra_kernel_args: '{{ extra_kernel_args}}{% if tux_boot_args %} {{ tux_boot_args }}{% endif %}'
{% endif %}

{%- set deploy_timeout = timeouts.deploy|default(30) %}
{%- set boot_timeout = timeouts.boot|default(15) %}

{% block timeouts %}
timeouts:
  job:
    minutes: {{ deploy_timeout + boot_timeout + tests_timeout }}
  connection:
    minutes: 2
  actions:
    power-off:
      seconds: 60
    finalize:
      seconds: 60
{% if LAVA_QUEUE_TIMEOUT is defined %}
  queue:
    hours: {{ LAVA_QUEUE_TIMEOUT }}
{% endif %}
{% endblock %}

actions:
- deploy:
    to: tftp
    timeout:
      minutes: {{ deploy_timeout }}
    os: {{ deploy_os|default(debian) }}
    kernel:
      url: "{{ kernel }}"
{% if compression(kernel)[1] is not none %}
      compression: {{ compression(kernel)[1] }}
      type: image
{% endif %}
{% if dtb %}
    dtb:
      url: "{{ dtb }}"
{% endif %}
{% if not is_cpio %}
    nfsrootfs:
      url: "{{ rootfs }}"
{% if compression(rootfs)[1] is not none %}
      compression: {{ compression(rootfs)[1] }}
{% endif %}
{% if compression(rootfs)[0] is not none %}
      format: {{ compression(rootfs)[0] }}
{% endif %}
{% if overlays %}
      overlays:
{% for name, overlay, dst in overlays %}
        {{ name }}:
          url: "{{ overlay }}"
          path: "{{ dst }}"
{% if compression(overlay)[0] is not none %}
          format: {{ compression(overlay)[0] }}
{% endif %}
{% if compression(overlay)[1] is not none %}
          compression: {{ compression(overlay)[1] }}
{% endif %}
{% endfor %}
{% endif %}
{% endif %}
{% if ramdisk %}
    ramdisk:
      url: "{{ ramdisk }}"
{% if compression(ramdisk)[1] is not none %}
      compression: {{ compression(ramdisk)[1] }}
{% endif %}
{% endif %}
- boot:
    method:
      {{ device.boot_method }}
    commands: {{ "ramdisk" if is_cpio else "nfs" }}
{% if device.boot_method == 'ipxe' %}
    parameters:
      shutdown-message: 'reboot: Restarting system'
{% endif %}
{% if qemu_image %}
    docker:
      image: {{ qemu_image }}
{% endif %}
    timeout:
      minutes: {{ boot_timeout }}
    auto_login:
      login_prompt: 'login:'
      username: root
    prompts:
    - 'root@(.*):[/~]#'
    - '/ #'
{% for prompt in tux_prompt %}
    - "{{ prompt }}"{% endfor %}

{% if not is_cpio and device.needs_storage_prep %}
- test:
    timeout:
      minutes: 5
    definitions:
    - from: inline
      repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: prep-tests
          description: "Device preparation"
        run:
          steps:
          - export STORAGE_DEV={{ device.storage_device }}
          - mkfs.ext4 -F "$STORAGE_DEV" || lava-test-raise "mkfs.ext4 $STORAGE_DEV failed; job exit"
          - mkdir -p /scratch && mount "$STORAGE_DEV" /scratch || lava-test-raise "mount $STORAGE_DEV failed; job exit"
          - df -h
          - mount
      name: prep-inline
      path: inline/prep.yaml
{% endif %}
