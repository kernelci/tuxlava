device_type: "qemu"

{% if tests %}
job_name: "tuxlava@{{ device.name }}: {{ tests|map(attribute="name")|join(", ")}}"
{% else %}
job_name: "tuxlava@{{ device.name }}: boot"
{% endif %}
priority: {{ LAVA_JOB_PRIORITY }}
visibility: "{{ visibility }}"

context:
    arch: "{{ lava_arch }}"
    machine: "{{ machine }}"
    cpu: "{{ cpu }}"
{% if memory %}
    memory: "{{ memory }}"
{% endif %}
    extra_options: ["-no-reboot", "{{ '", "'.join(extra_options) }}"]
    no_kvm: {{ no_kvm|lower }}
    no_network: {{ no_network|lower }}

{%- set deploy_timeout = timeouts.deploy|default(15) %}
{%- set boot_timeout = timeouts.boot|default(15) %}

{% block timeouts %}
timeouts:
  job:
    minutes: {{ deploy_timeout + boot_timeout + tests_timeout }}
  action:
   minutes: 5
  actions:
    power-off:
      seconds: 30
{% endblock %}

{%- set rootfs_format = compression(rootfs)[0] %}
{%- set is_cpio = (rootfs_format == "cpio" or "ramdisk" in rootfs|lower) %}

actions:
- deploy:
    to: tmpfs
    timeout:
      minutes: {{ deploy_timeout }}
    os: oe
    images:
      kernel:
        image_arg: '-kernel {kernel} -append "console={{ console }},115200 rootwait {% if not is_cpio %}root={{ rootfs_dev }}{{ rootfs_partition|default("", true) }} {% endif %}debug verbose console_msg_format=syslog systemd.log_level=warning{% if tux_boot_args %} {{ tux_boot_args }}{% endif %} earlycon"{% if shared %} -virtfs local,path={{ shared.0 }},mount_tag=tuxlava,security_model=mapped{% endif %}'
        url: "{{ kernel }}"
{% if compression(kernel)[1] is not none %}
        compression: {{ compression(kernel)[1] }}
{% endif %}
{% if secrets|length > 0 and secrets.keys()|list|first is not none %}
        headers:
           "Authorization": "{{ secrets.values()|list|first }}"
{% endif %}
{% if bios %}
      bios:
        image_arg: "-bios {bios}"
        url: "{{ bios }}"
{% endif %}
{% if dtb %}
      dtb:
        image_arg: "-dtb {dtb}"
        url: "{{ dtb }}"
{% if secrets|length > 0 and secrets.keys()|list|first is not none %}
        headers:
           "Authorization": "{{ secrets.values()|list|first }}"
{% endif %}
{% endif %}
      rootfs:
{% if is_cpio %}
        image_arg: "-initrd {rootfs}"
{% else %}
        image_arg: "{{ rootfs_arg }}"
{% endif %}
        url: "{{ rootfs }}"
{% if compression(rootfs)[1] is not none %}
        compression: {{ compression(rootfs)[1] }}
{% endif %}
{% if not is_cpio %}
        format: ext4
{% if skip_overlays %}
        overlays: {}
{% else %}
        overlays:
          lava: true
{% for name, overlay, dst in overlays %}
          {{ name }}:
            url: "{{ overlay }}"
            format: {{ compression(overlay)[0] }}
{% if compression(overlay)[1] is not none %}
            compression: {{ compression(overlay)[1] }}
            path: "{{ dst }}"
{% else %}
            path: "{{ dst }}{{ overlay.split('/')[-1] }}"
{% endif %}
{% if name == "modules" %}
{% if secrets|length > 0 and secrets.keys()|list|first is not none %}
            headers:
               "Authorization": "{{ secrets.values()|list|first }}"
{% endif %}
{% endif %}
{% endfor %}
{% endif %}
{% endif %}
- boot:
    method: qemu
{% if qemu_image %}
    docker:
      image: {{ qemu_image }}
{% endif %}
    timeout:
      minutes: {{ boot_timeout }}
{% if not enable_trustzone or "tfa-tests" not in tests|map(attribute="name")|join(", ") %}
{% if enable_auto_login and not is_cpio %}
    auto_login:
      login_prompt: 'login:'
      username: root
{% if shared %}
      login_commands:
      - mkdir -p {{ shared.1 }}
      - mount -t 9p -o trans=virtio tuxlava {{ shared.1 }}
{% endif %}
{% endif %}
    prompts:
{% if is_cpio or skip_overlays %}
    - '/ #'
{% endif %}
    - 'root@(.*):[/~]#'
{% for prompt in tux_prompt %}
    - "{{ prompt }}"{% endfor %}
{% endif %}
